# –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ CortexWatcher

üëâ –ê–Ω–≥–ª–æ–º–æ–≤–Ω–∞ –≤–µ—Ä—Å—ñ—è: [ARCHITECTURE.en.md](ARCHITECTURE.en.md)

## –û–≥–ª—è–¥
CortexWatcher —Å–∫–ª–∞–¥–∞—î—Ç—å—Å—è –∑ —á–æ—Ç–∏—Ä—å–æ—Ö –æ—Å–Ω–æ–≤–Ω–∏—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤:
- **bot** ‚Äî —Ç–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç –Ω–∞ aiogram, —â–æ –ø—Ä–∏–π–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Ç–∞ –ø–µ—Ä–µ–¥–∞—î —ó—Ö —É —á–µ—Ä–≥—É.
- **api** ‚Äî FastAPI –∑–∞—Å—Ç–æ—Å—É–Ω–æ–∫ –¥–ª—è HTTP —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ–π, –∑–∞–ø–∏—Ç—ñ–≤ –¥–æ –ª–æ–≥—ñ–≤, –∞–ª–µ—Ä—Ç—ñ–≤, –º–µ—Ç—Ä–∏–∫.
- **ingestor worker** ‚Äî –æ–±—Ä–æ–±–∫–∞ —á–µ—Ä–≥–∏ RQ: –ø–∞—Ä—Å–∏–Ω–≥, –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è, –∑–∞–ø–∏—Å —É —Å—Ö–æ–≤–∏—â–µ.
- **analyzer worker** ‚Äî –æ—Ü—ñ–Ω–∫–∞ –ø—Ä–∞–≤–∏–ª —Ç–∞ –∞–Ω–æ–º–∞–ª—ñ–π, —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è –∞–ª–µ—Ä—Ç—ñ–≤.

```
Telegram –≥—Ä—É–ø–∏ ‚Üí bot ‚Üí Redis (RQ) ‚Üí ingestor ‚Üí storage (Postgres/ClickHouse)
                                               ‚Üò
                                                analyzer ‚Üí alerts ‚Üí Telegram / API
```

## –î–∞–Ω—ñ —Ç–∞ —Å—Ö–æ–≤–∏—â–µ
- **PostgreSQL** ‚Äî –æ—Å–Ω–æ–≤–Ω–∞ –ë–î –¥–ª—è —Ç–∞–±–ª–∏—Ü—å `logs_raw`, `logs_normalized`, `alerts`, `anomalies`.
- **ClickHouse** (–æ–ø—Ü—ñ–π–Ω–æ) ‚Äî –¥–ª—è –≤–∏—Å–æ–∫–æ–Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ–≥–æ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è `logs_*`. –í–∏–±—ñ—Ä –∫–µ—Ä—É—î—Ç—å—Å—è –∑–º—ñ–Ω–Ω–æ—é `CLICKHOUSE`.
- **Redis** ‚Äî –±—Ä–æ–∫–µ—Ä —ñ –∫–µ—à –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –º–µ—Ç—Ä–∏–∫ (`/status`).

### SQLAlchemy ORM
–§–∞–π–ª–∏:
- `src/cortexwatcher/db/models.py` ‚Äî –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –º–æ–¥–µ–ª–µ–π.
- `src/cortexwatcher/db/session.py` ‚Äî —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ engine —Ç–∞ —Å–µ—Å—ñ–π.
- `src/cortexwatcher/storage/postgres.py` ‚Äî —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è.

## –ü–∞—Ä—Å–µ—Ä–∏
–£ –∫–∞—Ç–∞–ª–æ–∑—ñ `src/cortexwatcher/parsers/` —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –º–æ–¥—É–ª—ñ –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö —Ñ–æ—Ä–º–∞—Ç—ñ–≤ –ª–æ–≥—ñ–≤. –ú–æ–¥—É–ª—å `detect.py` –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–∑–Ω–∞—á–∞—î —Ñ–æ—Ä–º–∞—Ç.

## –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞
- `analyzer/rules_engine.py` ‚Äî –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–∞–≤–∏–ª —ñ–∑ YAML, –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è regex/glob —Ç–∞ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤.
- `analyzer/anomalies.py` ‚Äî –æ–±—á–∏—Å–ª–µ–Ω–Ω—è –∫–æ–≤–∑–Ω–∏—Ö –º–µ—Ç—Ä–∏–∫ (–∑-score, –º–µ–¥—ñ–∞–Ω–∞).
- `analyzer/correlate.py` ‚Äî —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è correlation_key.
- `analyzer/notifier.py` ‚Äî –≤—ñ–¥–ø—Ä–∞–≤–∫–∞ –∞–ª–µ—Ä—Ç—ñ–≤ —É Telegram —Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–ø–∏—Å—ñ–≤ —É –ë–î.

## API
FastAPI –∑–∞—Å—Ç–æ—Å—É–Ω–æ–∫ —ñ–∑ —Ä–æ—É—Ç–µ—Ä–∞–º–∏:
- `/ingest/{source}` ‚Äî –ø—Ä–∏–π–æ–º –ø–∞–∫–µ—Ç—ñ–≤ –ª–æ–≥—ñ–≤.
- `/logs`, `/alerts`, `/anomalies` ‚Äî —Ñ—ñ–ª—å—Ç—Ä–∏.
- `/healthz` ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞–Ω—É.
- `/metrics` ‚Äî Prometheus –º–µ—Ç—Ä–∏–∫–∏.

## –ß–µ—Ä–≥–∏
RQ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏—Ö –∑–∞–¥–∞—á:
- `workers/tasks.py` –º—ñ—Å—Ç–∏—Ç—å –∑–∞–¥–∞—á—ñ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥—É —Ç–∞ –∞–Ω–∞–ª—ñ–∑—É.
- `workers/ingestor.py` –∑–∞–ø—É—Å–∫–∞—î –≤–æ—Ä–∫–µ—Ä–∞ RQ.

## –ú—ñ–≥—Ä–∞—Ü—ñ—ó
–ê–ª–µ–º–±—ñ–∫ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ `src/cortexwatcher/db/migrations`. –ë–∞–∑–æ–≤–∏–π —Å–∫—Ä–∏–ø—Ç —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î —Ç–∞–±–ª–∏—Ü—ñ.

## –ú–µ—Ç—Ä–∏–∫–∏
- API –µ–∫—Å–ø–æ–Ω—É—î `/metrics` –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `prometheus_client`.
- Analyzer –æ–Ω–æ–≤–ª—é—î –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏ –ø–æ–¥—ñ–π —É Redis.

