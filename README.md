# CortexWatcher

CortexWatcher — це телеграм-бот та платформа для потокового збору, нормалізації та аналітики логів із різних джерел. Рішення орієнтоване на команди безпеки та SRE, які хочуть швидко обробляти події з Telegram-груп, Wazuh, Graylog та syslog, отримуючи структуровані алерти та метрики в одному місці.

## Можливості
- Прийом логів із Telegram (текст та файли, включно з .gz/.zip) та HTTP API (GELF, Wazuh, JSON/NDJSON).
- Нормалізація даних та збереження у PostgreSQL (або ClickHouse при увімкненні профілю).
- Правила виявлення подій та сигнатурні алерти на основі YAML-файлів.
- Виявлення аномалій за допомогою ковзних метрик (z-score, медіана).
- Інтеграція з Redis + RQ для асинхронних задач.
- FastAPI веб-інтерфейс із фільтрами по логам, алертам та стану сервісів.
- Метрики Prometheus (/metrics) для API та аналізатора.
- Структуроване логування в JSON-форматі.

## Швидкий старт (docker-compose)
1. Скопіюйте `.env.example` у `.env` та заповніть обовʼязкові змінні:
   ```bash
   cp .env.example .env
   ```
2. Запустіть інфраструктуру:
   ```bash
   docker compose up --build
   ```
3. Після старту:
   - FastAPI доступний на `http://localhost:8080` (документація `/docs`).
   - Prometheus метрики: `http://localhost:8080/metrics`.
   - Телеграм-бот очікує на команди у whitelisted групах.

## Локальна розробка
- Python 3.11 (рекомендується використовувати `pyenv` або `asdf`).
- Встановіть залежності та інструменти як у `Makefile setup`.
- Використовуйте `make format` перед комітом.
- Тести запускаються командою `make test`.

## Змінні середовища
Основні параметри конфігурації:
- `TG_BOT_TOKEN` — токен телеграм-бота.
- `ALLOWED_CHAT_IDS` — список дозволених chat_id (через кому).
- `DATABASE_URL` — URL підключення до PostgreSQL.
- `REDIS_URL` — URL Redis для черги RQ.
- `CLICKHOUSE_URL` — опціональне підключення до ClickHouse.
- `INGEST_MAX_FILE_MB` — максимальний розмір вхідного файлу.
- `ALERT_MIN_LEVEL` — мінімальний рівень алерту.
- `ANOMALY_WINDOW_MIN` — розмір вікна для аномалій (у хвилинах).
- `API_AUTH_TOKEN` — токен доступу до захищених ендпоінтів API.

## Типові сценарії
1. **Моніторинг Telegram-груп:** бот читає повідомлення з whitelisted груп, файли автоматично розпаковуються та передаються в чергу на нормалізацію.
2. **Парсинг syslog/JSON/GELF:** API приймає пакети логів, зберігає їх у сирому та нормалізованому вигляді, доступні фільтри у `/logs`.
3. **Інтеграція Wazuh:** окремий endpoint `/ingest/wazuh` приймає JSON-алерти, створює записи у таблиці `alerts` та відправляє повідомлення у Telegram.
4. **Перегляд алертів:** через `/alerts` можна відфільтрувати останні сповіщення та їх контекст.

## Обмеження та безпека
- Усі секрети задаються лише через `.env` або змінні середовища.
- Є whitelist chat_id для Telegram, базові rate-limit механізми.
- Реалізований контроль розміру файлів та захист від zip-bomb.
- Механізми аномалій базові й не замінюють повноцінні SIEM-рішення.

## Стартові задачі (Tickets)
- [ ] Імпорт TG-вкладень → ingestor → нормалізація → збереження.
- [ ] Реалізувати 3 приклади правил (SSH brute, NGINX 5xx burst, Wazuh high-level).
- [ ] Публікація алертів у TG + throttle.
- [ ] `/status` віддає основні лічильники з Redis/DB.
- [ ] Документація запуску (docker-compose) та локального деву.

